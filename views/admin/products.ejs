<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .main-content {
            margin-left: 250px;
            padding: 20px;
            background-image: url('/img/sneakers/adminSneakers.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            height: 100vh;
            overflow-y: auto;
        }

        .table-container {
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
        }

        .table {
            background-color: rgba(196, 255, 101, 0.5) !important;
            color: white;
            margin-bottom: 0;
            backdrop-filter: blur(10px);
        }

        .table thead th {
            text-align: center;
            vertical-align: middle;
            color: #000;
            background: rgba(255, 60, 60, 0.356);
            backdrop-filter: blur(10px);
            font-weight: 600;
            padding: 12px;
        }
        
        .table tbody td {
            text-align: center;
            vertical-align: middle;
            background: rgba(255, 239, 98, 0.438);
            backdrop-filter: blur(10px);
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .offer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .offer-btn {
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <%- include('../admin/adminPartials/sidebar') %>
    <%- include('../admin/adminPartials/cursor') %>

    <div class="main-content">
        <div class="container-fluid">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Product Name</th>
                                <th>Brand</th>
                                <th>Category</th>
                                <th>Regular Price</th>
                                <th>Sale Price</th>
                                <th>Offer</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% data.forEach(product => { %>
                                <tr>
                                    <td>
                                        <img src="/uploads/product-images/<%= product.productImage[0] %>" alt="<%= product.productName %>" class="product-image">
                                    </td>
                                    <td><%= product.productName %></td>
                                    <td><%= product.brand %></td>
                                    <td><%= product.category.name %></td>
                                    <td>₹<%= product.regularPrice %></td>
                                    <td>₹<%= product.salesPrice %></td>
                                    <td class="offer-section">
                                        <% if (product.productOffer) { %>
                                            <span><%= product.productOffer %>%</span>
                                            <button class="btn btn-danger offer-btn" onclick="removeOffer('<%= product._id %>')">Remove Offer</button>
                                        <% } else { %>
                                            <button class="btn btn-info offer-btn" onclick="addOffer('<%= product._id %>')">Add Offer</button>
                                        <% } %>
                                    </td>
                                    <td>
                                        <div class="stock-info">
                                            <div class="total-stock">Total: <%= product.totalQuantity %></div>
                                            <div class="size-breakdown">
                                                <span class="size-qty">S: <%= product.quantities?.small || 0 %></span>
                                                <span class="size-qty">M: <%= product.quantities?.medium || 0 %></span>
                                                <span class="size-qty">L: <%= product.quantities?.large || 0 %></span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge <%= product.status === 'Available' ? 'status-available' : 'status-unavailable' %>">
                                            <%= product.status %>
                                        </span>
                                    </td>
                                    <td>
                                        <a href="/admin/editProduct/<%= product._id %>" class="btn btn-primary me-2">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        <% if (product.status === 'Blocked') { %>
                                            <button onclick="unblockProduct('<%= product._id %>', this)" class="btn btn-success">
                                                <i class="fas fa-lock-open"></i> Unblock
                                            </button>
                                        <% } else { %>
                                            <button onclick="blockProduct('<%= product._id %>', this)" class="btn btn-danger">
                                                <i class="fas fa-lock"></i> Block
                                            </button>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script>
        function blockProduct(productId, button) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1000,
                background: '#4CAF50',
                color: 'white',
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            $.ajax({
                url: `/admin/blockProduct/${productId}`,
                method: 'PATCH',
                success: function(response) {
                    if(response.success) {
                        // Update button appearance
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-success');
                        button.setAttribute('onclick', `unblockProduct('${productId}', this)`);
                        button.innerHTML = '<i class="fas fa-lock-open"></i> Unblock';
                        
                        Toast.fire({
                            icon: 'success',
                            title: 'Product blocked successfully'
                        });
                    }
                },
                error: function(error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to block product'
                    });
                }
            });
        }

        function unblockProduct(productId, button) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1000,
                background: '#4CAF50',
                color: 'white',
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            $.ajax({
                url: `/admin/unblockProduct/${productId}`,
                method: 'PATCH',
                success: function(response) {
                    if(response.success) {
                        // Update button appearance
                        button.classList.remove('btn-success');
                        button.classList.add('btn-danger');
                        button.setAttribute('onclick', `blockProduct('${productId}', this)`);
                        button.innerHTML = '<i class="fas fa-lock"></i> Block';
                        
                        Toast.fire({
                            icon: 'success',
                            title: 'Product unblocked successfully'
                        });
                    }
                },
                error: function(error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to unblock product'
                    });
                }
            });
        }




        async function addProduct(productId) {
            const {value:amount} = await Swal.fire({
                title: 'offer in percentage',
                input: 'number',
                inputLabel: 'percentage',
                inputPlaceholder: '%'
            })
            $.ajax({
                url: `/admin/addProductOffer/${productId}`,
                method: 'post',
                data: {
                    percantage: amount,
                    product: productId
                },
                success: (response) => {
                    if(response.status===true){
                        location.reload()
                        swal.fire('Offer added','the offer has been removed','success')
                    }
                    else{
                        if(response.error){
                            swal.fire('Error',response.error,'error')
                        }
                    } 
                    
                }
            })
        }

function removeOffer(productId) {
    try {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!',
            timer: 5000,
            timerProgressBar: true
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/admin/removeProductOffer`,
                    method: 'post',
                    data: {
                        product: productId
                    },
                    success: (response) => {
                        if (response.status === true) {
                            swal.fire('Offer removed', 'the offer has been removed', 'success');
                            location.reload();
                        } else if (response.status === false) {
                            swal.fire('Error', response.error, 'error');
                        } else {
                            alert("failed");
                        }
                    }
                });
            }
        });
    } catch (err) {
        console.error(err);
    }
}
                    




    </script>
</body>
</html>